name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Detect which packages changed
  changes:
    runs-on: ubuntu-latest
    outputs:
      sdk: ${{ steps.filter.outputs.sdk }}
      cli: ${{ steps.filter.outputs.cli }}
      web: ${{ steps.filter.outputs.web }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            sdk:
              - 'packages/sdk/**'
            cli:
              - 'packages/cli/**'
            web:
              - 'apps/web/**'

  # SDK tests - only runs if SDK changed
  sdk:
    needs: changes
    if: ${{ needs.changes.outputs.sdk == 'true' || github.event_name == 'push' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm --filter veto-sdk build
      - run: pnpm --filter veto-sdk exec tsc --noEmit
      - run: pnpm --filter veto-sdk test

  # CLI tests - only runs if CLI changed
  cli:
    needs: changes
    if: ${{ needs.changes.outputs.cli == 'true' || github.event_name == 'push' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm --filter veto-cli build
      - run: pnpm --filter veto-cli typecheck
      - run: pnpm --filter veto-cli test

  # Web build - only runs if web changed
  web:
    needs: changes
    if: ${{ needs.changes.outputs.web == 'true' || github.event_name == 'push' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm --filter @veto/web build
      - run: pnpm --filter @veto/web exec tsc --noEmit

  # Go TUI build (CLI native binary)
  go:
    needs: changes
    if: ${{ needs.changes.outputs.cli == 'true' || github.event_name == 'push' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache-dependency-path: packages/cli/go/go.sum
      - name: Build Go binary
        working-directory: packages/cli/go
        run: |
          go build -ldflags="-s -w" -o veto-linux-amd64 ./cmd/veto
          echo "Built successfully"

  # Final status check (required for branch protection)
  status:
    runs-on: ubuntu-latest
    needs: [sdk, cli, web, go]
    if: always()
    steps:
      - name: Check status
        run: |
          if [[ "${{ needs.sdk.result }}" == "failure" ]] || \
             [[ "${{ needs.cli.result }}" == "failure" ]] || \
             [[ "${{ needs.web.result }}" == "failure" ]] || \
             [[ "${{ needs.go.result }}" == "failure" ]]; then
            exit 1
          fi
          echo "All checks passed!"
